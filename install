#!/usr/bin/env bash
#Usage:
# ./install [FORCE INSTALL] [REBUILD CONTAINERS] [DOCKER_PHP_IMAGE]
# Overridable vars.
FORCE=${1:-no}
REBUILD_CONTAINERS=${2:-no}
PHP_IMAGE=${3:-horaciolopesqq/phpnode}
# Defaults.
USER_ID=$(id -u)
GROUP_ID=$(id -g)
BOLD=$(tput bold)
NORMAL=$(tput sgr0)
INSTALLATION_TYPE="bare"

if [ -x "$(command -v docker)" ] && [ -x "$(command -v docker-compose)" ]; then
  INSTALLATION_TYPE="docker"
fi

FORCE=$([ "$FORCE" == "no" ] && echo "" || echo "--force")
if [ -f ".env" ] && [[ $FORCE == "--force" ]]; then rm -rf .env ; fi

# Prepare the environment.
if [ $INSTALLATION_TYPE == "docker" ]
then
  echo "Using ${BOLD}Docker Compose${NORMAL}."
  RUNNING_CONTAINERS=$(docker ps -q)
  if [ ! -z "$RUNNING_CONTAINERS" ]
  then
      (cd docker && docker kill $RUNNING_CONTAINERS) > /dev/null 2>&1
  fi
  # We need robo to set up the environment.
  (docker run --user ${USER_ID}:${GROUP_ID} --name php_install --rm -t -v $(pwd):/var/www/html $PHP_IMAGE composer install > /dev/null 2>&1)
  (docker run --user ${USER_ID}:${GROUP_ID} --name php_install --rm -t -v $(pwd):/var/www/html $PHP_IMAGE ./bin/robo pse --type docker > /dev/null 2>&1)
else
  # No docker, install on bare metal.
  echo "Using ${BOLD}Bare install${NORMAL}."
  composer install
  ./bin/robo pse
fi

# Export the vars in .env.
# The .env file should be present in the folder from where this script is invoked.
if [ ! -f ".env" ]; then
  echo "No .env file present. Stopping."
  exit 1
fi

# Load environment vars.
export $(egrep -v '^#' .env | xargs)
COMMAND=$([ "$ENVIRONMENT" == "development" ] && echo "composer install" || echo "composer install --no-dev")

# Install.
if [ $INSTALLATION_TYPE == "docker" ]; then
  docker run --user ${USER_ID}:${GROUP_ID} --name php_install --rm -t -v $(pwd):/var/www/html $PHP_IMAGE $COMMAND
  (docker-compose -f docker/docker-compose.yml up -d) \
  && docker exec -u ${USER_ID} php ./vendor/bin/robo pic $FORCE
  # Create an alias to open a tty in the php container.
  alias "dshp=docker exec -u 1000 -it php bash"
else
  $COMMAND
  ./vendor/bin/robo pic $FORCE
fi
